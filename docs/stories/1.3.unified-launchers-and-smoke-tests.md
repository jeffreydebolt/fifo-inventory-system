# Story 1.3: unified-launchers-and-smoke-tests

## Status
Draft

## Story
**As a** deployment engineer  
**I want** every launcher (CLI, Docker, Procfile, scripts) to start the same FastAPI application with automated smoke coverage  
**so that** environments behave consistently and regressions are caught early.

## Acceptance Criteria
1. All runtime launchers (`start.py`, Dockerfile CMD, Procfile, documented CLI examples) reference the canonical FastAPI application module established in Story 1.1.
2. Legacy references to removed FastAPI entrypoints are purged from scripts, documentation, and build artifacts to prevent accidental divergence.
3. Automated smoke tests (e.g., pytest with subprocess or TestClient) validate that the unified launcher boots and exposes `/health`, `/healthz`, and (when enabled) `/metrics`.
4. Deployment documentation (README or ops notes) describes the unified launch command (`uvicorn api.app:app` or equivalent) and how to run the new smoke test locally/CI.

## Tasks / Subtasks
- [ ] Align launcher scripts (AC: 1)
  - [ ] Update `start.py` to import and run the canonical FastAPI app (AC: 1)
  - [ ] Adjust Dockerfile CMD/entrypoint to use canonical module (AC: 1)
  - [ ] Update Procfile (and any Heroku/Railway configs) to call the same module (AC: 1)
- [ ] Remove stale references (AC: 2)
  - [ ] Search repository for old module names (`app_simple`, `app_minimal`, etc.) and update or delete usages (AC: 2)
  - [ ] Verify scripts (`build.sh`, demo utilities) do not import deprecated modules (AC: 2)
- [ ] Add automated smoke coverage (AC: 3)
  - [ ] Implement pytest-based smoke test launching app via TestClient or subprocess, asserting critical endpoints respond (AC: 3)
  - [ ] Ensure tests integrate with toggle behavior from Story 1.2 (metrics on/off) (AC: 3)
- [ ] Update documentation (AC: 4)
  - [ ] Revise deployment README(s) with canonical start command and smoke test instructions (AC: 4)
  - [ ] Note requirement to run smoke tests in CI/CD pipelines (AC: 4)

## Dev Notes
### Previous Story Insights
- Story 1.1 consolidates runtime logic into a single FastAPI module; launchers must now reference that canonical location.  
  [Source: docs/stories/1.1.canonical-fastapi-app.md]
- Story 1.2 introduces configuration toggles; smoke tests should exercise both enabled and disabled observability states where feasible.  
  [Source: docs/stories/1.2.configurable-observability-toggles.md]

### Runtime Context
- Current launch surfaces include FastAPI apps, CLI (`app/cli.py`), Docker (`start.py`), and Procfile entries. Aligning them removes “works on my machine” drift.  
  [Source: docs/architecture.md#runtime-contexts]

### Observability & Operations
- Smoke tests must verify `/health`, `/healthz`, and `/metrics` endpoints since they are key diagnostics. Metrics availability depends on toggles introduced in Story 1.2.  
  [Source: docs/architecture.md#observability--operations]

### Project Structure Alignment
- Launch code lives in repo root (`start.py`), container config (Dockerfile), and deployment manifests; keep modifications localized to these files without scattering entrypoints elsewhere.  
  [Source: docs/architecture/project-structure.md#root]

### Coding Standards & Testing
- Follow logging conventions when reporting launcher status, using `logging`.  
  [Source: docs/architecture/coding-standards.md#logging]
- Integration tests should reside under `tests/integration` and use pytest/HTTP clients consistent with existing suites.  
  [Source: docs/architecture/coding-standards.md#testing]

### Technology Stack Notes
- Continue using Uvicorn as the application server; ensure command examples rely on `uvicorn[standard]` per dependency list.  
  [Source: docs/architecture/tech-stack.md#application-layer]

### Assumptions & Edge Cases
- Smoke tests should be fast and not require live Supabase connectivity; mock or skip network calls as needed.
- Default launcher behavior should match pre-existing production settings when toggles are left at defaults.

## Testing
- Pytest smoke test verifying the unified launcher exposes `/health`, `/healthz`, and `/metrics` (when enabled).
- CI hook or script updating to run smoke tests after build.

## Change Log
| Date       | Version | Description                              | Author |
| ---------- | ------- | ---------------------------------------- | ------ |
| 2025-02-14 | v0.1    | Initial draft created from Epic 1 Story 3 | Bob    |

## Dev Agent Record
### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
