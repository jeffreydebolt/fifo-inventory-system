# Story 1.2: configurable-observability-toggles

## Status
Draft

## Story
**As a** platform maintainer  
**I want** to control observability integrations through explicit configuration toggles  
**so that** different environments can enable only the diagnostics they need while sharing the same FastAPI runtime.

## Acceptance Criteria
1. A configuration mechanism (e.g., settings module or structured env parsing) exposes explicit toggles for Prometheus metrics, Sentry initialization, and debug diagnostics, defaulting to current behavior when unset.
2. The canonical FastAPI application honors these toggles: metrics middleware and `/metrics` endpoint can be disabled, Sentry init can be skipped, and debug endpoints can be gated while core health checks remain available.
3. Repository documentation enumerates the new toggles (name, default, effect) so operators know how to configure environments.
4. Automated tests demonstrate toggle behavior (e.g., FastAPI TestClient verifying `/metrics` availability and Sentry hook execution) without relying on real external services.

## Tasks / Subtasks
- [ ] Design configuration strategy (AC: 1)  
  - [ ] Decide on `settings` implementation (e.g., Pydantic BaseSettings or custom loader) that reads env vars once (AC: 1)  
  - [ ] Define toggle names and defaults (`ENABLE_PROMETHEUS`, `ENABLE_SENTRY`, `ENABLE_DEBUG_ENDPOINTS`) (AC: 1)
- [ ] Update canonical FastAPI app to respect toggles (AC: 2)  
  - [ ] Wrap Prometheus middleware/endpoint registration behind metrics toggle (AC: 2)  
  - [ ] Guard Sentry initialization and logging integrations behind Sentry toggle (AC: 2)  
  - [ ] Control debug endpoints (`/debug/database`) visibility with debug toggle while preserving `/health` and `/healthz` (AC: 2)
- [ ] Document new configuration knobs (AC: 3)  
  - [ ] Update architecture or deployment docs with toggle descriptions and defaults (AC: 3)  
  - [ ] Note interplay with `.env` loading and deployment manifests (AC: 3)
- [ ] Add automated tests (AC: 4)  
  - [ ] Create FastAPI TestClient cases verifying metrics endpoint presence/absence based on toggle (AC: 4)  
  - [ ] Stub Sentry client to assert initialization occurs only when enabled (AC: 4)  
  - [ ] Ensure tests live under `tests/integration` or unit directory per standards (AC: 4)

## Dev Notes
### Previous Story Insights
- Story 1.1 consolidates runtime behavior into a single FastAPI application that retains routers, observability hooks, and health endpoints. Toggle implementation should build on that canonical surface without reintroducing multiple entrypoints.  
  [Source: docs/stories/1.1.canonical-fastapi-app.md]

### Observability & Operations
- Prometheus counters/histograms and `/metrics` endpoint are required features today; toggles must default to enabled so current behavior persists.  
  [Source: docs/architecture.md#integrations--infrastructure]
- Sentry initialization is optional and already keyed off `SENTRY_DSN`; the new toggle should provide explicit control beyond the presence of DSN.  
  [Source: docs/architecture.md#integrations--infrastructure]
- Debug endpoints (`/debug/database`) support Supabase diagnostics and should be disable-able in hardened environments while keeping `/health` endpoints for uptime checks.  
  [Source: docs/architecture.md#observability--operations]

### Coding Standards & Patterns
- Configuration should leverage environment variables loaded via `python-dotenv` to stay consistent with existing patterns.  
  [Source: docs/architecture/tech-stack.md#infrastructure--deployment]
- Maintain module-level logging conventions when reporting toggle states (avoid prints).  
  [Source: docs/architecture/coding-standards.md#logging]
- Keep FastAPI setup logic inside the canonical app module, delegating helper functions to `api/services` if necessary.  
  [Source: docs/architecture/coding-standards.md#fastapi-patterns]

### Project Structure Alignment
- Place configuration helpers within `api/` (e.g., `api/settings.py`) or another shared module documented in project structure; avoid scattering config logic across scripts.  
  [Source: docs/architecture/project-structure.md#root]

### Technology Stack Notes
- Use existing dependencies (`pydantic`, `python-dotenv`) before adding new configuration libraries.  
  [Source: docs/architecture/tech-stack.md#core-libraries]

### Testing Guidance
- Tests should use pytest with FastAPI TestClient to simulate toggle states; adhere to existing testing patterns in `tests/unit` and `tests/integration`.  
  [Source: docs/architecture/coding-standards.md#testing]
- Ensure tests cleanly override environment variables without polluting global state, using fixtures where appropriate.  
  [Source: docs/architecture.md#observability--operations]

### Assumptions & Edge Cases
- Toggle defaults must keep current production behavior to avoid regressions.
- Disabling metrics should not remove middleware necessary for other features (ensure only Prometheus pieces are disabled).

## Testing
- Pytest cases validating `/metrics` route availability when toggles enabled/disabled.
- Unit test or monkeypatch verifying Sentry initialization is skipped when toggle off even if DSN present.
- Regression smoke run confirming `/health` and `/healthz` remain accessible regardless of toggles.

## Change Log
| Date       | Version | Description                              | Author |
| ---------- | ------- | ---------------------------------------- | ------ |
| 2025-02-14 | v0.1    | Initial draft created from Epic 1 Story 2 | Bob    |

## Dev Agent Record
### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
