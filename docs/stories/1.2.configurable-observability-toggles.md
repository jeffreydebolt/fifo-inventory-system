# Story 1.2: configurable-observability-toggles

## Status
Ready for Review

## Story
**As a** platform maintainer  
**I want** to control observability integrations through explicit configuration toggles  
**so that** different environments can enable only the diagnostics they need while sharing the same FastAPI runtime.

## Acceptance Criteria
1. A configuration mechanism (e.g., settings module or structured env parsing) exposes explicit toggles for Prometheus metrics, Sentry initialization, and debug diagnostics, defaulting to current behavior when unset.
2. The canonical FastAPI application honors these toggles: metrics middleware and `/metrics` endpoint can be disabled, Sentry init can be skipped, and debug endpoints can be gated while core health checks remain available.
3. Repository documentation enumerates the new toggles (name, default, effect) so operators know how to configure environments.
4. Automated tests demonstrate toggle behavior (e.g., FastAPI TestClient verifying `/metrics` availability and Sentry hook execution) without relying on real external services.

## Tasks / Subtasks
- [x] Design configuration strategy (AC: 1)  
  - [x] Decide on `settings` implementation (e.g., Pydantic BaseSettings or custom loader) that reads env vars once (AC: 1)  
  - [x] Define toggle names and defaults (`ENABLE_PROMETHEUS`, `ENABLE_SENTRY`, `ENABLE_DEBUG_ENDPOINTS`) (AC: 1)
- [x] Update canonical FastAPI app to respect toggles (AC: 2)  
  - [x] Wrap Prometheus middleware/endpoint registration behind metrics toggle (AC: 2)  
  - [x] Guard Sentry initialization and logging integrations behind Sentry toggle (AC: 2)  
  - [x] Control debug endpoints (`/debug/database`) visibility with debug toggle while preserving `/health` and `/healthz` (AC: 2)
- [x] Document new configuration knobs (AC: 3)  
  - [x] Update architecture or deployment docs with toggle descriptions and defaults (AC: 3)  
  - [x] Note interplay with `.env` loading and deployment manifests (AC: 3)
- [x] Add automated tests (AC: 4)  
  - [x] Create FastAPI TestClient cases verifying metrics endpoint presence/absence based on toggle (AC: 4)  
  - [x] Stub Sentry client to assert initialization occurs only when enabled (AC: 4)  
  - [x] Ensure tests live under `tests/integration` or unit directory per standards (AC: 4)

## Dev Notes
### Previous Story Insights
- Story 1.1 consolidates runtime behavior into a single FastAPI application that retains routers, observability hooks, and health endpoints. Toggle implementation should build on that canonical surface without reintroducing multiple entrypoints.  
  [Source: docs/stories/1.1.canonical-fastapi-app.md]

### Observability & Operations
- Prometheus counters/histograms and `/metrics` endpoint are required features today; toggles must default to enabled so current behavior persists.  
  [Source: docs/architecture.md#integrations--infrastructure]
- Sentry initialization is optional and already keyed off `SENTRY_DSN`; the new toggle should provide explicit control beyond the presence of DSN.  
  [Source: docs/architecture.md#integrations--infrastructure]
- Debug endpoints (`/debug/database`) support Supabase diagnostics and should be disable-able in hardened environments while keeping `/health` endpoints for uptime checks.  
  [Source: docs/architecture.md#observability--operations]

### Coding Standards & Patterns
- Configuration should leverage environment variables loaded via `python-dotenv` to stay consistent with existing patterns.  
  [Source: docs/architecture/tech-stack.md#infrastructure--deployment]
- Maintain module-level logging conventions when reporting toggle states (avoid prints).  
  [Source: docs/architecture/coding-standards.md#logging]
- Keep FastAPI setup logic inside the canonical app module, delegating helper functions to `api/services` if necessary.  
  [Source: docs/architecture/coding-standards.md#fastapi-patterns]

### Project Structure Alignment
- Place configuration helpers within `api/` (e.g., `api/settings.py`) or another shared module documented in project structure; avoid scattering config logic across scripts.  
  [Source: docs/architecture/project-structure.md#root]

### Technology Stack Notes
- Use existing dependencies (`pydantic`, `python-dotenv`) before adding new configuration libraries.  
  [Source: docs/architecture/tech-stack.md#core-libraries]

### Testing Guidance
- Tests should use pytest with FastAPI TestClient to simulate toggle states; adhere to existing testing patterns in `tests/unit` and `tests/integration`.  
  [Source: docs/architecture/coding-standards.md#testing]
- Ensure tests cleanly override environment variables without polluting global state, using fixtures where appropriate.  
  [Source: docs/architecture.md#observability--operations]

### Assumptions & Edge Cases
- Toggle defaults must keep current production behavior to avoid regressions.
- Disabling metrics should not remove middleware necessary for other features (ensure only Prometheus pieces are disabled).

## Testing
- Pytest cases validating `/metrics` route availability when toggles enabled/disabled.
- Unit test or monkeypatch verifying Sentry initialization is skipped when toggle off even if DSN present.
- Regression smoke run confirming `/health` and `/healthz` remain accessible regardless of toggles.

## Change Log
| Date       | Version | Description                              | Author |
| ---------- | ------- | ---------------------------------------- | ------ |
| 2025-02-14 | v0.1    | Initial draft created from Epic 1 Story 2 | Bob    |

## Dev Agent Record
### Agent Model Used
OpenAI GPT-5

### Debug Log References
- `pytest tests/unit/test_observability_toggles.py`

### Completion Notes List
- Added `api/settings.py` to centralize observability toggles sourced from environment variables with cached access.
- Updated `api/app.py` to honor Prometheus, Sentry, and debug endpoint toggles while improving logging around configuration state.
- Documented the new toggles in `docs/architecture.md` and noted the settings module in `docs/architecture/project-structure.md`.
- Added regression coverage in `tests/unit/test_observability_toggles.py` for metrics, debug endpoints, and Sentry initialization behavior.

### File List
- api/app.py
- api/settings.py
- docs/architecture.md
- docs/architecture/project-structure.md
- docs/stories/1.2.configurable-observability-toggles.md
- requirements.txt
- tests/unit/test_observability_toggles.py

## QA Results

### Review Date: 2025-10-15
### Reviewed By: Quinn (Test Architect)

#### Summary
- ✅ Confirmed `api/settings.py` centralizes observability toggles with cached lookup and sane defaults (all enabled).
- ✅ Verified `api/app.py` respects toggles for Prometheus metrics, Sentry initialization, and debug endpoints while maintaining health routes.
- ✅ Documentation updated to describe the toggles and project structure now references the new settings module.
- ✅ `tests/unit/test_observability_toggles.py` exercises toggle permutations, ensuring endpoints/tests behave as expected.

#### Requirements Traceability
- **AC1** – `api/settings.py` defines `ENABLE_PROMETHEUS`, `ENABLE_SENTRY`, `ENABLE_DEBUG_ENDPOINTS`, and `SENTRY_DSN` overrides with defaults.
- **AC2** – `api/app.py` gates metrics middleware, `/metrics`, Sentry init, and `/debug/database` on the corresponding toggles.
- **AC3** – `docs/architecture.md` and `docs/architecture/project-structure.md` enumerate the toggles and note the new settings module.
- **AC4** – `tests/unit/test_observability_toggles.py` validates metrics endpoint visibility, debug endpoint gating, and Sentry initialization.

#### Testing Evidence
- Manual: `pytest tests/unit/test_observability_toggles.py`

#### Observations & Recommendations
- Tests currently clear Prometheus state via private registry attributes; consider switching to a custom `CollectorRegistry` in tests to avoid relying on internal structures.
- No blocking issues detected; code paths honor toggles without impacting default behavior.

#### NFR Assessment
- **Security**: PASS – No change to auth surface; Sentry can be disabled where required.
- **Performance**: PASS – Disabling Prometheus removes instrumentation overhead when desired.
- **Reliability**: PASS – Health endpoints remain available; toggles logged at startup for observability.
- **Maintainability**: PASS – Centralized configuration and documentation clarity improve future changes.

#### Status
- Recommended Story Status: Ready for Done
- Issues Requiring Follow-up: None (one future recommendation noted above)
