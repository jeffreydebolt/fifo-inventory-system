# Story 1.1: canonical-fastapi-app

## Status
Draft

## Story
**As a** platform maintainer  
**I want** to consolidate the API service onto a single FastAPI application entry point  
**so that** deployments and tooling always execute the same runtime behavior without divergence.

## Acceptance Criteria
1. A single canonical FastAPI application file is defined (e.g., `api/app.py`) that registers existing routers, CORS policy, health endpoints, Prometheus metrics, and Sentry hooks consolidated from all current variants.
2. Legacy FastAPI entrypoint files (`api/app_simple.py`, `api/app_minimal.py`, `api/app_simple_production.py`) are removed or refactored to proxy the canonical app without duplicating configuration, with references updated inside those files if retained.
3. Repository documentation noting multiple entrypoints is updated to reference only the canonical application so developers know which module to import.

## Tasks / Subtasks
- [ ] Audit existing FastAPI app modules to capture required features (AC: 1)  
  - [ ] Document the routers, middleware, logging, metrics, and diagnostics each variant currently enables (AC: 1)
- [ ] Build the canonical FastAPI app file by merging required functionality (AC: 1)  
  - [ ] Ensure router inclusion (`runs`, `files`) matches current production surface (AC: 1)  
  - [ ] Consolidate observability hooks: Prometheus metrics, Sentry init, logging config (AC: 1)  
  - [ ] Preserve health endpoints (`/health`, `/healthz`, `/debug/database`) with consistent responses (AC: 1)
- [ ] Retire or proxy alternate app files (AC: 2)  
  - [ ] Replace contents with imports to the canonical app or archive them, leaving clear deprecation notice (AC: 2)  
  - [ ] Search repository for references to removed modules and update imports accordingly (AC: 2)
- [ ] Update documentation describing runtime contexts (AC: 3)  
  - [ ] Revise `docs/architecture.md` “Runtime Contexts” section to reflect single entrypoint (AC: 3)  
  - [ ] Note the canonical module in deployment notes or README as appropriate (AC: 3)
- [ ] Perform local smoke check of canonical app (AC: 1,2)  
  - [ ] Start app via `uvicorn api.app:app` and verify `/health`, `/healthz`, `/metrics` return expected responses (AC: 1)

## Dev Notes
### Previous Story Insights
No prior stories exist for this epic; this is the first increment.

### Runtime Context
- The service currently exposes multiple FastAPI entrypoints (`api/app.py`, `api/app_simple.py`, `api/app_minimal.py`, `api/app_simple_production.py`), each mixing routers, CORS settings, metrics, and diagnostics differently. The canonical file must preserve router inclusion, health endpoints, and diagnostics from these variants while eliminating duplication.  
  [Source: docs/architecture.md#runtime-contexts]

### Observability & Operations
- Prometheus counters/histograms (`REQUEST_COUNT`, `REQUEST_DURATION`) and the `/metrics` endpoint need to remain available in the unified app.  
  [Source: docs/architecture.md#integrations--infrastructure]
- Sentry initialization is optional and only enabled when `SENTRY_DSN` is configured; retain this guarded setup.  
  [Source: docs/architecture.md#integrations--infrastructure]
- Health endpoints (`/health`, `/healthz`, `/debug/database`) are part of the expected diagnostics surface and must be preserved.  
  [Source: docs/architecture.md#observability--operations]

### Coding Standards & Patterns
- Follow the project’s logging practices by using module-level loggers (`logging.getLogger(__name__)`) and avoid ad-hoc print statements.  
  [Source: docs/architecture/coding-standards.md#logging]
- Keep FastAPI request/response models in `api/models.py` and routers under `api/routes/`. New runtime helpers should live alongside existing patterns rather than introducing new directories.  
  [Source: docs/architecture/coding-standards.md#fastapi-patterns]

### Project Structure Alignment
- Canonical FastAPI application lives in `api/`. Router modules remain in `api/routes/`, and services in `api/services/`; refactoring should not relocate those packages.  
  [Source: docs/architecture/project-structure.md#root]

### Technology Stack Notes
- Runtime remains Python 3.11 with FastAPI (0.104.1), Prometheus client, Sentry SDK, and Uvicorn. No new dependencies should be introduced while consolidating the app.  
  [Source: docs/architecture/tech-stack.md#application-layer]

### Testing Guidance
- Existing pytest suites live under `tests/`. Add or update smoke tests under `tests/integration` to cover the unified app if gaps appear.  
  [Source: docs/architecture/coding-standards.md#testing]
- Manual verification of `/health`, `/healthz`, and `/metrics` endpoints is expected for this story; automated coverage can be extended in Story 1.3.  
  [Source: docs/architecture.md#observability--operations]

### Notes on Missing Artifacts
- Architecture sharded index (`docs/architecture/index.md`) is not present; all references above point to the existing consolidated documents.

## Testing
- Manual smoke test via `uvicorn api.app:app` ensuring `/health`, `/healthz`, and `/metrics` respond without errors.
- Update or add pytest coverage in `tests/integration` if the unified app exposes routes not currently exercised.

## Change Log
| Date       | Version | Description                                 | Author |
| ---------- | ------- | ------------------------------------------- | ------ |
| 2025-02-14 | v0.1    | Initial draft created from Epic 1 Story 1    | Bob    |
| 2025-02-14 | v0.2    | Validated story contents (no edits required) | Sarah  |

## Dev Agent Record
### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
